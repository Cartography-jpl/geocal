#! /usr/bin/env python
#
# This runs a job from a shelf file.

from afids import *
from optparse import OptionParser

parser = OptionParser(version="%prog September 6, 2012",
usage="""usage: %prog [options] [database file] [job index]

This runs a job that is a pickled function stored in a shelve
database file. The function should take no arguments, we just 
execute the save function. This is useful when doing things like
submitting jobs to torque.

You don't normally run this directly, rather this gets run as
part of a torque job.

We normally get the database file from the environment variable
"SHELVE_DATABASE_FILE", and the index of the job from "PBS_ARRAYID".
You can also pass this on the command line, which can be useful when
testing to directly run a job.
""")

(options, args) = parser.parse_args()
if(len(args) > 2):
    parser.error("Need to specify the right number of arguments")
if(len(args) == 2):
    fname, job_index = args
else:
    job_index = os.environ["PBS_ARRAYID"]
    if(len(args) == 1):
        fname, = args
    else:
        fname = os.environ["SHELVE_DATABASE_FILE"]

job_index = int(job_index)

print "Starting job %d from %s" % (job_index, fname)
f = read_shelve(fname + ":job_%d" % job_index)
f()
print "Done with job %d from %s" % (job_index, fname)

